<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"> <title>Handling Many to Many Updates in ASP.NET Core &#8211; Justin Wendlandt's Blog</title> <meta name="description" content="When updating a database object using Entity Framework Core and ASP.NET Core there is a decent amount of complexity involved with handling what’s in the database and what is selected from the UI.­ScenarioSay we have a table Post and another table Tag with a many-to-many relationship between them defined as PostTag. When the user is editing a post, they have the opportunity to select and de-select options that may already exist in the database. Below there are a few options in how to handle this, but one of the more performant options is to do more of a “merge” operation between what’s in the database and what is selected in the UI.The Brute Force MethodOne approach could be to call .Clear() on the collection and then call .Update(post) on the context. The issue with this is that we may be deleting items from the many-to-many table that we may want to keep in the database because they are still selected in the UI.The “Merge” MethodMerging is a bit tricky, but for us LINQ comes to the rescue. We can use something like LINQPad to mock this up. Essentially, we will switch the Language header on LINQPad to “Statement(s)” like the screenshot below.Then inside the query editor window we can use the following snippet.var selected = new List&lt;int&gt;() { 1, 2, 3, 4 };var database = new List&lt;int&gt;() { 2, 4, 5 };selected.Except(database).Dump(&quot;Added&quot;);database.Except(selected).Dump(&quot;Removed&quot;);Essentially the first line that says selected.Except() is taking the set of ids from the left and producing a set with the values inside the .Except parameter. So in our case Added ids are 1 and 3.The second line uses database.Except() which takes the database items and creates a set of values that don’t match with the selected values. So in our example, the Removed id is just 5.The output would look like the following screenshot."> <meta name="keywords" content="asp.net, linq"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="halve.png"> <meta name="twitter:title" content="Handling Many to Many Updates in ASP.NET Core"> <meta name="twitter:description" content="When updating a database object using Entity Framework Core and ASP.NET Core there is a decent amount of complexity involved with handling what’s in the database and what is selected from the UI.­ScenarioSay we have a table Post and another table Tag with a many-to-many relationship between them defined as PostTag. When the user is editing a post, they have the opportunity to select and de-select options that may already exist in the database. Below there are a few options in how to handle this, but one of the more performant options is to do more of a “merge” operation between what’s in the database and what is selected in the UI.The Brute Force MethodOne approach could be to call .Clear() on the collection and then call .Update(post) on the context. The issue with this is that we may be deleting items from the many-to-many table that we may want to keep in the database because they are still selected in the UI.The “Merge” MethodMerging is a bit tricky, but for us LINQ comes to the rescue. We can use something like LINQPad to mock this up. Essentially, we will switch the Language header on LINQPad to “Statement(s)” like the screenshot below.Then inside the query editor window we can use the following snippet.var selected = new List&lt;int&gt;() { 1, 2, 3, 4 };var database = new List&lt;int&gt;() { 2, 4, 5 };selected.Except(database).Dump(&quot;Added&quot;);database.Except(selected).Dump(&quot;Removed&quot;);Essentially the first line that says selected.Except() is taking the set of ids from the left and producing a set with the values inside the .Except parameter. So in our case Added ids are 1 and 3.The second line uses database.Except() which takes the database items and creates a set of values that don’t match with the selected values. So in our example, the Removed id is just 5.The output would look like the following screenshot."> <meta name="twitter:site" content="@jwendl"> <meta name="twitter:creator" content="@jwendl"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="Handling Many to Many Updates in ASP.NET Core"> <meta property="og:description" content="When updating a database object using Entity Framework Core and ASP.NET Core there is a decent amount of complexity involved with handling what’s in the database and what is selected from the UI.­ScenarioSay we have a table Post and another table Tag with a many-to-many relationship between them defined as PostTag. When the user is editing a post, they have the opportunity to select and de-select options that may already exist in the database. Below there are a few options in how to handle this, but one of the more performant options is to do more of a “merge” operation between what’s in the database and what is selected in the UI.The Brute Force MethodOne approach could be to call .Clear() on the collection and then call .Update(post) on the context. The issue with this is that we may be deleting items from the many-to-many table that we may want to keep in the database because they are still selected in the UI.The “Merge” MethodMerging is a bit tricky, but for us LINQ comes to the rescue. We can use something like LINQPad to mock this up. Essentially, we will switch the Language header on LINQPad to “Statement(s)” like the screenshot below.Then inside the query editor window we can use the following snippet.var selected = new List&lt;int&gt;() { 1, 2, 3, 4 };var database = new List&lt;int&gt;() { 2, 4, 5 };selected.Except(database).Dump(&quot;Added&quot;);database.Except(selected).Dump(&quot;Removed&quot;);Essentially the first line that says selected.Except() is taking the set of ids from the left and producing a set with the values inside the .Except parameter. So in our case Added ids are 1 and 3.The second line uses database.Except() which takes the database items and creates a set of values that don’t match with the selected values. So in our example, the Removed id is just 5.The output would look like the following screenshot."> <meta property="og:url" content="http://localhost:4000/2017/10/18/handling-many-to-many-asp-net/"> <meta property="og:site_name" content="Justin Wendlandt's Blog"> <meta property="og:image" content="http://localhost:4000/images/halve.png"> <link rel="canonical" href="http://localhost:4000/2017/10/18/handling-many-to-many-asp-net/"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Feed --> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Justin Wendlandt's Blog" /> <!-- Favicons --> <link rel="shortcut icon" type="image/png" href="http://localhost:4000/favicon.png" /> <link rel="shortcut icon" href="http://localhost:4000/favicon.ico" /> <!-- CSS --> <link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/main.css"> <!-- Left Block Image for Posts --> <style type="text/css"> #posts.inner-post-page .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(http://localhost:4000/images/unsplash-gallery-image-3.jpg) no-repeat;background-size: cover;} </style> <!-- Left Block Images for Home and Pages --> <style type="text/css"> #posts .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(http://localhost:4000/images/unsplash-image-10.jpg) no-repeat;background-size: cover, cover;} .block-left {background: linear-gradient(rgba(44,45,51,0.9), rgba(44,45,51,0.9)), url(http://localhost:4000/images/home.png) no-repeat;background-size: cover;} </style> </head> <body id="posts" class="inner-post-page"> <div class="block-left"> <div class="content"> <a href="http://localhost:4000" class="logo"><img src="http://localhost:4000/images/halve.png"></a> <div class="post-title-section"> <div class="section-line">Posts <em>/</em></div> <h1 class="section-title">Handling Many to Many Updates in ASP.NET Core </h1> <ul class="tags"> <li><a href="http://localhost:4000/tags#asp.net">asp.net</a></li> <li><a href="http://localhost:4000/tags#linq">linq</a></li> </ul> <div class="section-line reverse"><a href="http://localhost:4000/posts">Back to posts</a> <em>/</em></div> </div> </div> </div> <div class="block-right"> <div class="share-buttons"> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/2017/10/18/handling-many-to-many-asp-net/" class="btn btn_twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/2017/10/18/handling-many-to-many-asp-net/" class="btn btn_facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> <a href="https://plus.google.com/share?url=http://localhost:4000/2017/10/18/handling-many-to-many-asp-net/" class="btn btn_google-plus" title="Share on Google Plus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a> </div> <a href="http://localhost:4000/posts.html" title="posts" class="posts-menu-icon"></a> <a title="http://localhost:4000/projects" class="projects-menu-icon"> <span></span> </a> <div class="inner-post content"> <div class="date-highlight">18 Oct 2017</div> <p>When updating a database object using Entity Framework Core and ASP.NET Core there is a decent amount of complexity involved with handling what’s in the database and what is selected from the UI. ­</p> <h3 id="scenario">Scenario</h3> <p>Say we have a table Post and another table Tag with a many-to-many relationship between them defined as PostTag. When the user is editing a post, they have the opportunity to select and de-select options that may already exist in the database. Below there are a few options in how to handle this, but one of the more performant options is to do more of a “merge” operation between what’s in the database and what is selected in the UI.</p> <h3 id="the-brute-force-method">The Brute Force Method</h3> <p>One approach could be to call .Clear() on the collection and then call .Update(post) on the context. The issue with this is that we may be deleting items from the many-to-many table that we may want to keep in the database because they are still selected in the UI.</p> <h3 id="the-merge-method">The “Merge” Method</h3> <p>Merging is a bit tricky, but for us LINQ comes to the rescue. We can use something like <a href="http://www.linqpad.net/">LINQPad</a> to mock this up. Essentially, we will switch the Language header on LINQPad to “Statement(s)” like the screenshot below.</p> <p><img src="/images/LinqPadExpression.png" alt="LINQPad Expression" /></p> <p>Then inside the query editor window we can use the following snippet.</p> <figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="kt">var</span> <span class="n">selected</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;()</span> <span class="p">{</span> <span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span> <span class="p">};</span>
<span class="kt">var</span> <span class="n">database</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;()</span> <span class="p">{</span> <span class="m">2</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">5</span> <span class="p">};</span>
<span class="n">selected</span><span class="p">.</span><span class="nf">Except</span><span class="p">(</span><span class="n">database</span><span class="p">).</span><span class="nf">Dump</span><span class="p">(</span><span class="s">"Added"</span><span class="p">);</span>
<span class="n">database</span><span class="p">.</span><span class="nf">Except</span><span class="p">(</span><span class="n">selected</span><span class="p">).</span><span class="nf">Dump</span><span class="p">(</span><span class="s">"Removed"</span><span class="p">);</span></code></pre></figure> <p>Essentially the first line that says selected.Except() is taking the set of ids from the left and producing a set with the values inside the .Except parameter. So in our case Added ids are 1 and 3.</p> <p>The second line uses database.Except() which takes the database items and creates a set of values that don’t match with the selected values. So in our example, the Removed id is just 5.</p> <p>The output would look like the following screenshot.</p> <p><img src="/images/LinqPadExpressionResults.png" alt="Cluster Screen #001" /></p> <br /> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/2017/10/18/handling-many-to-many-asp-net/" class="btn btn_twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/2017/10/18/handling-many-to-many-asp-net/" class="btn btn_facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> <a href="https://plus.google.com/share?url=http://localhost:4000/2017/10/18/handling-many-to-many-asp-net/" class="btn btn_google-plus" title="Share on Google Plus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a> <div id="page_uri" value="/2017/10/18/handling-many-to-many-asp-net/" style="display: none;">&nbsp;</div> <div id="page_title" value="Handling Many to Many Updates in ASP.NET Core" style="display: none;">&nbsp;</div> <div id="disqus_thread"></div> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> <script type="text/javascript" src="/assets/js/disqus.js"></script> <nav class="pagination"> <a href="http://localhost:4000/2017/10/01/useful-visual-studio-extensions/" class="pagination_pager" title="Useful Visual Studio Extensions ">previous</a> <a href="#" class="pagination_pager disabled">Next</a> </nav> </div> </div> <!-- JS --> <script src="http://localhost:4000/assets/js/main.min.js"></script> <div class="overlay"> <ul class="projects-menu"> <li style="background:url(http://taylantatli.me/Halve/images/halve-home-image.png) center center no-repeat;"> <a href="http://taylantatli.me/Halve" class="inactive" target="_blank" rel="nofollow external"> <span> Halve Jekyll Theme <br><em>in progress</em> </span> </a> </li> <li style="background:url(https://cloud.githubusercontent.com/assets/754514/14509720/61c61058-01d6-11e6-93ab-0918515ecd56.png) center center no-repeat;"> <a href="http://taylantatli.me/Moon" target="_blank" rel="nofollow external"> <span> Moon Jekyll Theme </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/Ramme/master/assets/img/screenshot-post.png) center center no-repeat;"> <a href="http://taylantatli.me/Ramme" target="_blank" rel="nofollow external"> <span> Ramme Jekyll Theme </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/Daisy-Pelican-Theme/master/Preview-1.png) center center no-repeat;"> <a href="http://taylantatli.me/Daisy-Pelican-Theme/" target="_blank" rel="nofollow external"> <span> Daisy Pelican Theme </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/Block-Icon-Theme/master/Preview.png) center center no-repeat;"> <a href="https://github.com/TaylanTatli/Block-Icon-Theme" class="inactive" target="_blank" rel="nofollow external"> <span> Block Icon Theme <br><em>in progress</em> </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/StartPage/master/preview.png) center center no-repeat;"> <a href="http://taylantatli.me/StartPage/" class="inactive" target="_blank" rel="nofollow external"> <span> Start Page <br><em>in progress</em> </span> </a> </li> </ul> </div> </body> </html>
